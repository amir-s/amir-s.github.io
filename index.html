
<!DOCTYPE html>
<html>
  <head>
    <title>Geekozy / Amir Saboury&#39;s blog!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="http://geekozy.com/theme/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="http://geekozy.com/theme/css/font-awesome.min.css" rel="stylesheet" media="screen">
    <link href="http://geekozy.com/theme/style.css" rel="stylesheet" media="screen">
    <link href="http://geekozy.com/theme/css/hljs.default.css" rel="stylesheet" media="screen">

    <link href='http://fonts.googleapis.com/css?family=Josefin+Sans|Maven+Pro|Montserrat+Alternates' rel='stylesheet' type='text/css' />

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="http://geekozy.com/theme/js/html5shiv.js"></script>
      <script src="http://geekozy.com/theme/js/respond.min.js"></script>
    <![endif]-->

  </head>
  <body>
    <div id="header">
      <h1><a href="http://geekozy.com/"><span>&nbsp;/GEEKOZY/&nbsp;</span></a></h1>
      <h6><a href="http://geekozy.com/"><span>&nbsp;sharing ideas about computer science, programing, and geeky stuff!&nbsp;</span></a></h6>
    </div>
    <div class="container">
      

      <div class="post container">
        <div class="title">
          <h2><a href="http://geekozy.com/posts/producer-consumer-in-javascript">Producer-Consumer in JavaScript</a></h2>
          <div class="socialbuzz">
            <!-- Twitter -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="as32">Tweet</a>
            <!-- Google + -->
            <g:plusone class="plusone" size="medium"></g:plusone>
          </div>
        </div>
        <div class="post-detail">
          <p>Wednesday 24<sup>th</sup> September 2014, By Amir Saboury, Tags: <a href="http://geekozy.com/tags/javascript">#javascript</a> -- <a href="http://geekozy.com/posts/producer-consumer-in-javascript#disqus_thread" data-disqus-identifier="producer-consumer-in-javascript"></a></p>
        </div>
        <div class="post-content"><p>Couple of month ago, I wrote a XMPP-bot which acts like a chat-room. It simply sends all the messages that it received to the other people that have added the bot. There is already some online services for this purpose like <a href="http://partych.at">PartyChat</a>, but as I wanted something more customized so I started to write my own.</p>
<p>I used <a href="http://www.nodejs.org">NodeJS</a> to write bot. using <a href="https://github.com/node-xmpp/node-xmpp">Node-XMPP</a> module made the whole process very easy. The only problem was when a lot of users try to send messages. First, I had used a simple logic to broadcast messages to the other users, which was fine when there was no rush in incoming messages:</p>
<pre><code class="lang-javascript">xmpp.on(<span class="string">'chat'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(from, body)</span> {</span>
    users.forEcah(<span class="function"><span class="keyword">function</span> <span class="params">(user)</span> {</span>
        xmpp.send(user, <span class="string">'['</span> + from + <span class="string">']: '</span> + body);
    });
});</code></pre>
<p>When a lot of messages came at the same time, not all of them had sent to the other users. So I needed to change the broadcast strategy.</p>
<p>I needed to schedule sending out messages in a way that there will be enough delay between each <code>xmpp.send</code> call. This is a kind of <a href="http://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">Producer-Consumer Problem</a>.</p>
<p>I wanted a module that I can work with it like this:</p>
<pre><code>var consumerFunction = function (item) {
    // consume the item
    xmpp<span class="preprocessor">.send</span>(item<span class="preprocessor">.to</span>, item<span class="preprocessor">.body</span>)<span class="comment">;</span>
}
var queue = new Queue(consumerFunction, delay)<span class="comment">;</span>
queue<span class="preprocessor">.push</span>(something)<span class="comment">;</span>
queue<span class="preprocessor">.push</span>(somethingElse)<span class="comment">;</span></code></pre>
<p>And it automatically feed the input into the <code>consumerFunction</code> with the specified amount of delay.</p>
<p>First we should create a <code>Queue.js</code> file in our project and fill it with necessary lines:</p>
<pre><code><span class="keyword">var</span> Queue = <span class="function"><span class="keyword">function</span> <span class="params">(fn, delay)</span> <span class="comment">{
}</span>
<span class="title">module</span>.<span class="title">exports</span> = <span class="title">Queue</span>;</span></code></pre>
<p>Every <code>Queue</code> instanced that will be <code>new</code>ed is a new queue. We have to keep the consumer function and the delay for each created queue in itself. And also we need an array in which we keep our stuff to be consumed later:</p>
<pre><code>var Queue = function (<span class="keyword">fn</span>, delay) {
    this.<span class="function"><span class="keyword">fn</span> = <span class="title">fn</span>;
    <span class="title">this</span>.<span class="title">delay</span> = <span class="title">delay</span>;
    <span class="title">this</span>.<span class="title">Q</span> = [];
}
<span class="title">module</span>.<span class="title">exports</span> = <span class="title">Queue</span>;</code></pre>
<p>As we&#39;ve seen before, we also need a <code>push</code> function on our <code>Qeueu</code>. This function should first see if there is a consumption job going on already or not. If there is, then we can just simply push the thing into the array and let the consumer consume it. If there isn&#39;t, we should add the item into the array and then notify the consumer to process that stuff. We can add a flag to our <code>Queue</code> which keeps track of business of the queue.</p>
<pre><code>var Queue = function (fn, delay) {
    <span class="keyword">this</span><span class="variable">.fn</span> = fn;
    <span class="keyword">this</span><span class="variable">.delay</span> = delay;
    <span class="keyword">this</span><span class="variable">.Q</span> = [];
    <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    <span class="keyword">this</span><span class="variable">.push</span> = function (item) {
        <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.push</span>(item);
        <span class="keyword">if</span> (!<span class="keyword">this</span><span class="variable">.busy</span>) <span class="keyword">this</span><span class="variable">.notify</span>();
    }
    <span class="keyword">this</span><span class="variable">.notify</span> = function () {
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">true</span>;
        var item = <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.shift</span>();
        <span class="keyword">this</span><span class="variable">.fn</span>(item);
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    }
}
module<span class="variable">.exports</span> = Queue;</code></pre>
<p>Now the <code>notify</code> function should do the rest of the job. It should consume the first element of array by feeding it into the consumer function (which named <code>this.fn</code> here), and then to schedule the next call of itself to see if there is any job remains.</p>
<p>In order to schedule the next call, we should use <code>setTimeout</code> function. As you may know, <code>this</code> pointer does not preserved in nested function calls. So we should store our <code>this</code> into another variable to access <code>this.fn</code> into a nested function. Here I used the variable name <code>self</code> which is more convenient.</p>
<pre><code>var Queue = function (fn, delay) {
    <span class="keyword">this</span><span class="variable">.fn</span> = fn;
    <span class="keyword">this</span><span class="variable">.delay</span> = delay;
    <span class="keyword">this</span><span class="variable">.Q</span> = [];
    <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    <span class="keyword">this</span><span class="variable">.push</span> = function (item) {
        <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.push</span>(item);
        <span class="keyword">if</span> (!<span class="keyword">this</span><span class="variable">.busy</span>) <span class="keyword">this</span><span class="variable">.notify</span>();
    }
    <span class="keyword">this</span><span class="variable">.notify</span> = function () {
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">true</span>;
        var item = <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.shift</span>();
        <span class="keyword">this</span><span class="variable">.fn</span>(item);
        var <span class="keyword">self</span> = <span class="keyword">this</span>;
        setTimeout(function () {
            <span class="keyword">self</span><span class="variable">.notify</span>();
        }, <span class="keyword">this</span><span class="variable">.delay</span>);
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    }
}
module<span class="variable">.exports</span> = Queue;</code></pre>
<p>But wait! We haven&#39;t manipulate the <code>busy</code> flag very well. And what will be happen when the array become empty? We have to check first if the array is empty or not. If it is empty, then we are finished for now and we can unset the <code>busy</code> flag and rest. And if the array isn&#39;t empty, just peek an item, consume, then schedule next consumption.</p>
<pre><code>var Queue = function (fn, delay) {
    <span class="keyword">this</span><span class="variable">.fn</span> = fn;
    <span class="keyword">this</span><span class="variable">.delay</span> = delay;
    <span class="keyword">this</span><span class="variable">.Q</span> = [];
    <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    <span class="keyword">this</span><span class="variable">.push</span> = function (item) {
        <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.push</span>(item);
        <span class="keyword">if</span> (!<span class="keyword">this</span><span class="variable">.busy</span>) <span class="keyword">this</span><span class="variable">.notify</span>();
    }
    <span class="keyword">this</span><span class="variable">.notify</span> = function () {
        <span class="keyword">if</span> (<span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.length</span> == <span class="number">0</span>) {
            <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
            <span class="keyword">return</span>;
        }
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">true</span>;
        var item = <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.shift</span>();
        <span class="keyword">this</span><span class="variable">.fn</span>(item);
        var <span class="keyword">self</span> = <span class="keyword">this</span>;
        setTimeout(function () {
            <span class="keyword">self</span><span class="variable">.notify</span>();
        }, <span class="keyword">this</span><span class="variable">.delay</span>);
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    }
}
module<span class="variable">.exports</span> = Queue;</code></pre>
<p>Well, that&#39;s all. Another thing is when we call the <code>fn</code> function in this way: <code>this.fn(item)</code> if user uses the <code>this</code> keyword in the <code>fn</code> function, their <code>this</code> will become our <code>this</code>. It is safer if we call it this way: <code>this.fn.call(null, item);</code>. Now <code>fn</code>&#39;s <code>this</code> is going to be bound to <code>null</code>.</p>
<p>Here is the final code. This is probably not the best way to do it, but it was fun and very easy to implement.</p>
<p>How do you test this kind of modules? Tell me in the comments and we can have a post in future about testing these stuff.</p>
<pre><code>var Queue = function (fn, delay) {
    <span class="keyword">this</span><span class="variable">.fn</span> = fn;
    <span class="keyword">this</span><span class="variable">.delay</span> = delay;
    <span class="keyword">this</span><span class="variable">.Q</span> = [];
    <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    <span class="keyword">this</span><span class="variable">.push</span> = function (item) {
        <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.push</span>(item);
        <span class="keyword">if</span> (!<span class="keyword">this</span><span class="variable">.busy</span>) <span class="keyword">this</span><span class="variable">.notify</span>();
    }
    <span class="keyword">this</span><span class="variable">.notify</span> = function () {
        <span class="keyword">if</span> (<span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.length</span> == <span class="number">0</span>) {
            <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
            <span class="keyword">return</span>;
        }
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">true</span>;
        var item = <span class="keyword">this</span><span class="variable">.Q</span><span class="variable">.shift</span>();
        <span class="keyword">this</span><span class="variable">.fn</span><span class="variable">.call</span>(null, item);
        var <span class="keyword">self</span> = <span class="keyword">this</span>;
        setTimeout(function () {
            <span class="keyword">self</span><span class="variable">.notify</span>();
        }, <span class="keyword">this</span><span class="variable">.delay</span>);
        <span class="keyword">this</span><span class="variable">.busy</span> = <span class="literal">false</span>;
    }
}
module<span class="variable">.exports</span> = Queue;</code></pre>
</div>
     

      </div>


      

      <div class="post container">
        <div class="title">
          <h2><a href="http://geekozy.com/posts/first-post">First Post</a></h2>
          <div class="socialbuzz">
            <!-- Twitter -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="as32">Tweet</a>
            <!-- Google + -->
            <g:plusone class="plusone" size="medium"></g:plusone>
          </div>
        </div>
        <div class="post-detail">
          <p>Tuesday 23<sup>rd</sup> September 2014, By Amir Saboury, Tags: <a href="http://geekozy.com/tags/introduction">#introduction</a>, <a href="http://geekozy.com/tags/pressjs">#pressjs</a> -- <a href="http://geekozy.com/posts/first-post#disqus_thread" data-disqus-identifier="first-post"></a></p>
        </div>
        <div class="post-content"><p>It&#39;s been a while that I wish to start blogging. I&#39;ve wrote a tool called <a href="https://github.com/amir-s/pressjs">PressJS</a> like one year ago to start creating and writing a blog using that tool. But I failed due to some reasons.</p>
<h2 id="about-myself">About myself</h2>
<p>My name is Amir, I was born in 14th April, 1990. Now I am a student of <a href="http://polymtl.ca">Ecole Polytechnique de Montreal</a> in Canada, studying Computer Engeering. <a href="http://amir.saboury.net">This</a> is my (kind of) academic web-page.</p>
<p>I love Programing, <a href="http://instagram.com/amir.saboury">Photography</a>, and pretty much everything in between!</p>
<h2 id="pressjs">PressJS</h2>
<p>Well, done is better than perfect; So I&#39;m going to start blogging anyway using <a href="https://github.com/amir-s/pressjs">PressJS</a> while I&#39;m developing it.</p>
<p><a href="https://github.com/amir-s/pressjs">PressJS</a> is not going to be YABP (Yet Another Blogging Platform). This is just a personal project that I want to develope and it&#39;s main goal is to be minimalistic and dead simple. It has a few features now, but it will be developed and more features will be added very soon.</p>
<p>If you are interested in using and developing it, feel free to fork and send pull-requests.</p>
<p>In order to user <code>pressjs</code>, you must have NodeJS installed first. Then install <code>pressjs</code> from <code>npm</code>:</p>
<pre><code><span class="title">npm</span> install pressjs -g</code></pre>
<p>And you are all set! Create a folder for your blog:</p>
<pre><code><span class="title">mkdir</span> blog &amp;&amp; cd blog</code></pre>
<p>Use this command to initialize your blog:</p>
<pre><code><span class="title">pressjs</span> init</code></pre>
<p>With this command, <code>pressjs</code> will copy static files for the blog theme, and a config file named <code>blog.js</code> in the working directory.
Edit <code>blog.js</code> with a text editor and fill your desired values. Remember you should have a trailing <code>/</code> for your URL. All the URLs of your blog, will be joined with this URL.</p>
<p>For your first post, create a file named <code>new.md</code>: (the <code>^D</code> is the end of input character: <code>ctrl</code>+<code>D</code>)</p>
<pre><code>touch new.md
cat &gt; new.md
Title: My <span class="keyword">first</span> post
tags: <span class="keyword">first</span>, introduction, pressjs
<span class="comment">-------------------------------------------</span>
Lorem Ipsum <span class="keyword">is</span> simply dummy <span class="type">text</span> <span class="keyword">of</span> <span class="keyword">the</span> printing <span class="keyword">and</span> typesetting industry. Lorem Ipsum has been <span class="keyword">the</span> industry's standard dummy <span class="type">text</span> ever <span class="keyword">since</span> <span class="keyword">the</span> <span class="number">1500</span>s, when an unknown printer took a galley <span class="keyword">of</span> type <span class="keyword">and</span> scrambled <span class="keyword">it</span> <span class="keyword">to</span> make a type specimen book. It has survived <span class="keyword">not</span> only five centuries, <span class="keyword">but</span> also <span class="keyword">the</span> leap <span class="keyword">into</span> electronic typesetting, remaining essentially unchanged. It was popularised <span class="keyword">in</span> <span class="keyword">the</span> <span class="number">1960</span>s <span class="keyword">with</span> <span class="keyword">the</span> release <span class="keyword">of</span> Letraset sheets containing Lorem Ipsum passages, <span class="keyword">and</span> more recently <span class="keyword">with</span> desktop publishing software like Aldus PageMaker including versions <span class="keyword">of</span> Lorem Ipsum.

    Lorem Ipsum <span class="keyword">is</span> simply dummy <span class="type">text</span> <span class="keyword">of</span> <span class="keyword">the</span> printing <span class="keyword">and</span> typesetting industry. Lorem Ipsum has been <span class="keyword">the</span> industry's standard dummy <span class="type">text</span> ever <span class="keyword">since</span> <span class="keyword">the</span> <span class="number">1500</span>s, when an unknown printer took a galley <span class="keyword">of</span> type <span class="keyword">and</span> scrambled <span class="keyword">it</span> <span class="keyword">to</span> make a type specimen book. It has survived <span class="keyword">not</span> only five centuries, <span class="keyword">but</span> also <span class="keyword">the</span> leap <span class="keyword">into</span> electronic typesetting, remaining essentially unchanged. It was popularised <span class="keyword">in</span> <span class="keyword">the</span> <span class="number">1960</span>s <span class="keyword">with</span> <span class="keyword">the</span> release <span class="keyword">of</span> Letraset sheets containing Lorem Ipsum passages, <span class="keyword">and</span> more recently <span class="keyword">with</span> desktop publishing software like Aldus PageMaker including versions <span class="keyword">of</span> Lorem Ipsum.

^D</code></pre>
<p>Now it is time to build this post:</p>
<pre><code><span class="title">pressjs</span> build new.md</code></pre>
<p>You can test your blog by starting a local web server:</p>
<pre><code><span class="title">pressjs</span> test</code></pre>
<p>Navigate your browser to <code>http://localhost:3000</code> and test your blog. Remember, the <code>pressjs test</code> command, changes the URL of your blog in the entire files to <code>localhost:3000</code>. You should run <code>pressjs update</code> again after your tests, before uploading your blog.</p>
<p><code>pressjs update</code> is also useful when you change your <code>blog.js</code> config file or delete some posts in <code>./posts/</code> folder. Make sure you run <code>pressjs update</code> to make the changes.</p>
<p>Have fun.</p>
</div>
     

      </div>


      


      
      <div id="pagination" class="container">
        <ul class="pagination pagination-sm">
          <li><a href="http://geekozy.com/page/1">&laquo;</a></li>
          
          <li class="active"><a href="http://geekozy.com/page/1">1</a></li>
          
          <li><a href="http://geekozy.com/page/1">&raquo;</a></li>
        </ul>
      </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="http://geekozy.com/theme/js/jquery-1.10.2.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="http://geekozy.com/theme/js/bootstrap.min.js"></script>

    <!-- Twitter Social -->
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="http://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

    <!-- G+ -->
    <script type="text/javascript">
    (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>
	
  
  <script type="text/javascript">
  var disqus_shortname = 'amirsaboury';
   
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
  </script>
  

	
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55074548-1', 'auto');
    ga('send', 'pageview');

  </script>
  

  </body>
</html>
